/*
 * generated by Xtext 2.25.0
 */
package org.xtext.example.mydsl.validation

import org.eclipse.xtext.validation.Check
import org.xtext.example.mydsl.projectDSL.Controller
import java.util.ArrayList
import org.xtext.example.mydsl.projectDSL.ProjectDSLPackage.Literals
import org.xtext.example.mydsl.projectDSL.Entity
import org.xtext.example.mydsl.projectDSL.Parameter
import org.xtext.example.mydsl.projectDSL.RestAPI
import org.xtext.example.mydsl.projectDSL.impl.EntityImpl
import org.xtext.example.mydsl.projectDSL.impl.ControllerImpl
import org.xtext.example.mydsl.projectDSL.impl.ParentEntityImpl


/**
 * This class contains custom validation rules. 
 *
 * See https://www.eclipse.org/Xtext/documentation/303_runtime_concepts.html#validation
 */
class ProjectDSLValidator extends AbstractProjectDSLValidator {
	
	// Checks that the controller is not containing duplicate endpoints
	@Check
	def checkMakeOperations(Controller c) {
		val endpointNames = new ArrayList<String>
		// We add the names of each of the endpoints.
		c.endpoint.forEach[
			if(endpointNames.contains(it.endpoint.name)) {
				error ("Endpoint already exists!", it, Literals.ENDPOINT__ENDPOINT)
			} else {
				endpointNames.add(it.endpoint.name)
			}
		]
	}
	
	// Checks that each controller only 'uses' entities once
	@Check
	def checkDuplicateUsesStatement(Controller c) {
		val entitiesUsed = new ArrayList<String>
		c.base.forEach[
			if(entitiesUsed.contains(it.name)){
				error ("Duplicate entities not allowed!", c, Literals.CONTROLLER__BASE)
			} else {
				entitiesUsed.add(it.name)
			}
		]
	}
	
	// Checks that each entity does not contain duplicate parameters
	@Check
	def checkDuplicateParameter(Entity e) {
		val entityParameterNames = new ArrayList<String>
		e.parameters.forEach[
			if(entityParameterNames.contains(it.name)) {
				error ("Parameter already exists!", it, Literals.PARAMETER__NAME)
			} else {
				entityParameterNames.add(it.name)
			}
		]
	}
    
    // Checks that there are no duplicate CRUD operations for each parameter e.g. Age = int R R
    @Check
    def checkDuplicateCRUD(Parameter parameter){
    	for(var i = 0; i < parameter.type.length; i++){
            for(var j = 0; j < parameter.type.length; j++){
                if(i != j && parameter.type.get(i) == parameter.type.get(j)){
                    error("Parameters contains duplicates of " + parameter.type.get(i), parameter, Literals.PARAMETER__NAME)
                }
            }
        }
    }
    
    // Checks that there are no duplicates of either entities, controllers and parent entities
    @Check
    def checkDuplicateEntitiesOrControllers(RestAPI api){
    	val entityNames = new ArrayList<String>
    	val controllerNames = new ArrayList<String>
    	val parentNames = new ArrayList<String>
    	api.declarations.forEach[
    		if(it.class == EntityImpl && !entityNames.contains(it.name)){
    			entityNames.add(it.name)
    		
    		}else if(it.class == ControllerImpl && !controllerNames.contains(it.name)){
    			controllerNames.add(it.name)
    			
    		}else if(it.class == ParentEntityImpl && !parentNames.contains(it.name)){
    			parentNames.add(it.name)
  
    		}else{
    			error("Already exists", it, null)
    		}
    	]
    }
	
}
